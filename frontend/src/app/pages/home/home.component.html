<section class="feed-shell" aria-live="polite">
  <div class="feed-hero shadow-sm rounded-4 d-flex flex-column flex-md-row align-items-md-center justify-content-between">
    <div>
      <p class="eyebrow text-uppercase mb-1">Your feed</p>
      <h1 class="mb-2">Keep your cohort in the loop.</h1>
      <p class="mb-0 text-white-50">
        Share what you shipped or learned this week. When someone you follow posts, it will show up below.
      </p>
    </div>
    <button class="btn btn-primary btn-lg mt-3 mt-md-0" type="button" (click)="openComposer()" [disabled]="!currentUserId">
      Add post
    </button>
  </div>
  <div *ngIf="loadError" class="alert alert-danger" role="alert">{{ loadError }}</div>

  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-light" role="status"></div>
  </div>

  <div *ngIf="!isLoading && posts.length === 0" class="empty-state">
    <p class="eyebrow">All caught up</p>
    <h2>No new updates from your cohort.</h2>
    <p class="text-white-50">When someone you follow posts an update, it will appear here.</p>
  </div>

  <div class="post-grid" *ngIf="posts.length > 0">
    <article
      class="post-card"
      *ngFor="let post of posts; trackBy: trackByPost"
      tabindex="0"
      role="button"
      (click)="openPost(post)"
      (keydown)="onCardKeyDown($event, post)"
      [attr.aria-label]="'Open post ' + post.title"
    >
      <header class="post-header">
        <div>
          <button
            type="button"
            class="author"
            (click)="openProfile(post.author.id, $event)"
            [attr.aria-label]="'View profile for ' + post.author.name"
          >
            {{ post.author.name }}
          </button>
          <p class="timestamp">{{ post.createdAt | date: 'medium' }}</p>
        </div>
      </header>
      <h3>{{ post.title }}</h3>
      <p class="description">{{ getPreview(post.description) }}</p>
      <p class="read-more" *ngIf="shouldShowReadMore(post.description)">
        Continue reading â†’
      </p>
      <div class="media-grid" *ngIf="post.media?.length">
        <ng-container *ngFor="let media of post.media | slice:0:1">
          <img *ngIf="media.type === 'IMAGE'" [src]="media.url" [alt]="media.originalFileName || post.title" />
          <video *ngIf="media.type === 'VIDEO'" [src]="media.url" controls></video>
        </ng-container>
        <div class="media-overlay" *ngIf="post.media.length > 1">
          +{{ post.media.length - 1 }} more attachment(s)
        </div>
      </div>
      <div class="post-actions">
        <button
          type="button"
          class="like-button"
          (click)="toggleLike(post, $event)"
          [disabled]="isLikePending(post.id)"
          [attr.aria-pressed]="post.likedByCurrentUser"
          [attr.aria-label]="post.likedByCurrentUser ? 'Remove like' : 'Like post'"
        >
          <i class="bi" [ngClass]="post.likedByCurrentUser ? 'bi-heart-fill' : 'bi-heart'"></i>
          <span class="count">{{ post.likeCount }}</span>
        </button>
        <div class="comment-count" aria-label="Total comments on this post">
          <i class="bi bi-chat-dots"></i>
          <span class="count">{{ post.commentCount }}</span>
        </div>
      </div>
    </article>
  </div>
</section>

<div class="composer-backdrop" *ngIf="composerOpen">
  <div class="composer-dialog" role="dialog" aria-modal="true">
    <header class="composer-header">
      <h2>Create a post</h2>
      <button type="button" class="composer-close" aria-label="Close" (click)="closeComposer()">
        <i class="bi bi-x-lg" aria-hidden="true"></i>
      </button>
    </header>
    <form [formGroup]="postForm" (ngSubmit)="submitPost()" novalidate>
      <div class="mb-3">
        <label class="form-label">Title</label>
        <input
          type="text"
          class="form-control"
          formControlName="title"
          placeholder="Give your post a name"
          [attr.maxlength]="titleMaxLength"
        />
        <div class="form-text text-end">
          {{ titleLength }}/{{ titleMaxLength }} characters
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Post</label>
        <textarea
          rows="4"
          class="form-control"
          formControlName="description"
          placeholder="What did you learn, fix, or ship?"
          [attr.maxlength]="postMaxLength"
        ></textarea>
        <div class="form-text text-end">
          {{ postLength }}/{{ postMaxLength }} characters
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label d-flex justify-content-between align-items-center gap-2">
          <span>Media (optional, up to {{ maxMedia }} files)</span>
          <small class="text-white-50">{{ remainingMediaSlots }} slot(s) left</small>
        </label>
        <input type="file" class="form-control" multiple (change)="onFilesSelected($event)" [disabled]="hasReachedMediaLimit" />
      </div>
      <div class="media-previews" *ngIf="mediaPreviews.length">
        <div class="preview" *ngFor="let media of mediaPreviews; let i = index">
          <button type="button" class="composer-close preview-close" aria-label="Remove" (click)="removeMedia(i)">
            <i class="bi bi-x-lg" aria-hidden="true"></i>
          </button>
          <img *ngIf="media.kind === 'image'" [src]="media.previewUrl" alt="Media preview" />
          <video *ngIf="media.kind === 'video'" [src]="media.previewUrl" controls></video>
        </div>
      </div>
      <div *ngIf="composerError" class="alert alert-danger" role="alert">{{ composerError }}</div>
      <div class="composer-actions">
        <button type="button" class="btn btn-outline-secondary" (click)="closeComposer()">Cancel</button>
        <button type="submit" class="btn btn-primary" [disabled]="submitting">
          <span *ngIf="!submitting">Publish</span>
          <span *ngIf="submitting" class="d-inline-flex align-items-center gap-2">
            <span class="spinner-border spinner-border-sm"></span>
            Posting...
          </span>
        </button>
      </div>
    </form>
  </div>
</div>
